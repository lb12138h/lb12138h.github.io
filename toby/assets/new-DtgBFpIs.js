import{a as L,b as B,r as u,j as e,B as x,i as T,p as U,k as a,T as i}from"./index-Cysz9zD0.js";import{F as s,I as l}from"./input-CEaxjduA.js";import{I as R,d as S}from"./crypto-JqBCi-j7.js";import{T as h}from"./text-area-SZlL3kce.js";import{u as f}from"./dexie-react-hooks-1XYa5HEM.js";import{F as C}from"./FilterTag-DHm5gu_a.js";const N=()=>{const n=L(),{id:o}=B(),c=f(()=>a.db.web.orderBy("order").last().then(r=>((r==null?void 0:r.order)||0)+1),[],0),g=f(async()=>await a.db.web.orderBy("url").keys(),[],[]),[d]=s.useForm(),[b,p]=u.useState(),[y,j]=u.useState(!1);u.useEffect(()=>{(async()=>{if(!o){c&&p({order:c});return}const t=await a.db.web.get(+o);if(!t){n(-1);return}p(t)})()},[c,o,n]);const I=async r=>{j(!0),o?await a.db.web.update(+o,{...r,hostname:new URL(r.url).hostname,order:+r.order}).then(()=>{i.show({icon:"success",content:"编辑成功!"}),d.resetFields(),n(-1)}).catch(t=>{i.show({icon:"fail",content:t.message})}):await a.db.web.add({...r,hostname:new URL(r.url).hostname,order:+r.order}).then(()=>{i.show({icon:"success",content:"新建成功!"}),d.resetFields(),n(-1)}).catch(t=>{i.show({icon:"fail",content:t.message})}),j(!1)};return e.jsx("div",{children:b&&e.jsxs(s,{name:"form",form:d,onFinish:I,initialValues:b,footer:e.jsx(x,{block:!0,type:"submit",color:"primary",loading:y,children:"提交"}),children:[e.jsx(s.Item,{name:"title",label:"名称",rules:[{required:!0}],children:e.jsx(l,{placeholder:"请输入名称"})}),e.jsx(s.Item,{name:"url",label:"地址",validateFirst:!0,rules:[{required:!0},{validator:(r,t)=>{try{new URL(t)}catch{return Promise.reject(new Error("url格式错误!"))}return!o&&g.includes(t)?Promise.reject(new Error("url不能重复!")):Promise.resolve()}}],children:e.jsx(h,{placeholder:"请输入地址",autoSize:!0})}),e.jsx(s.Item,{name:"wh",label:"宽高",children:e.jsx(l,{placeholder:"请输入宽高"})}),e.jsx(s.Item,{name:"whr",label:"宽高比",children:e.jsx(l,{placeholder:"请输入宽高比"})}),e.jsx(s.Item,{name:"simpleDesc",label:"简短介绍",children:e.jsx(h,{placeholder:"请输入简短介绍",autoSize:!0})}),e.jsx(s.Item,{name:"desc",label:"描述",children:e.jsx(h,{placeholder:"请输入描述",autoSize:!0})}),e.jsx(s.Item,{name:"icon",label:"icon",children:e.jsx(R,{multiple:!0,maxCount:1,upload:async r=>{const t=URL.createObjectURL(r),m=await T(t),F=await S(m),w=await U(F,m);return w.success?{url:w.data}:Promise.reject()}})}),e.jsx(s.Item,{name:"tags",label:"标签",children:e.jsx(C,{webConfig:a})}),e.jsx(x,{className:"ml-4 mb-2",size:"small",color:"primary",onClick:()=>{n(`${a.path}/tag`)},children:"新增"}),e.jsx(s.Item,{name:"order",label:"排序",rules:[{required:!0}],children:e.jsx(l,{type:"number",placeholder:"请输入排序"})})]})})};export{N as default};
