import{n as T,o as B,r as f,j as e,B as y,p as U,q as v,z as o,T as j}from"./index-ossK1LZ4.js";import{F as s,I as l}from"./input-CrX-0v2G.js";import{I as z,d as S}from"./crypto-D6ec2ZFR.js";import{T as x}from"./text-area-F7y7FmZS.js";import{u as I}from"./dexie-react-hooks-SU3VEuhl.js";import{F as k}from"./FilterTag-C75_zTfn.js";const D=()=>{const u=T(),{id:i}=B(),p=I(()=>o.db.web.orderBy("order").last().then(a=>((a==null?void 0:a.order)||0)+1),[],0),F=I(async()=>await o.db.web.orderBy("url").keys(),[],[]),[b]=s.useForm(),[h,w]=f.useState(),[L,g]=f.useState(!1);f.useEffect(()=>{(async()=>{if(!i){p&&w({order:p});return}const t=await o.db.web.get(+i);if(!t){u(-1);return}w(t)})()},[p,i,u]);const P=async a=>{g(!0);const t={...a,hostname:new URL(a.url).hostname,order:+a.order,page:+a.page},n=t.order;if(n!==p&&n!==(h==null?void 0:h.order)){const c=(await o.db.web.orderBy("order").toArray()).filter(r=>i&&r.id!==+i).filter(r=>r.order&&r.order>=n).map((r,d)=>({key:r.id,changes:{order:d+n+1}}));c.length&&await o.db.web.bulkUpdate(c)}i?await o.db.web.update(+i,t).then(()=>{j.show({icon:"success",content:"编辑成功!"}),b.resetFields(),u(-1)}).catch(m=>{j.show({icon:"fail",content:m.message})}):await o.db.web.add(t).then(()=>{j.show({icon:"success",content:"新建成功!"}),b.resetFields(),u(-1)}).catch(m=>{j.show({icon:"fail",content:m.message})}),g(!1)};return e.jsx("div",{children:h&&e.jsxs(s,{name:"form",form:b,onFinish:P,initialValues:h,footer:e.jsx(y,{block:!0,type:"submit",color:"primary",loading:L,children:"提交"}),children:[e.jsx(s.Item,{name:"title",label:"名称",rules:[{required:!0}],children:e.jsx(l,{placeholder:"请输入名称"})}),e.jsx(s.Item,{name:"orginTitle",label:"源名称",children:e.jsx(l,{placeholder:"请输入源名称"})}),e.jsx(s.Item,{name:"inWebTitle",label:"网站中名称",children:e.jsx(l,{placeholder:"请输入网站中名称"})}),e.jsx(s.Item,{name:"author",label:"作者",children:e.jsx(l,{placeholder:"请输入作者"})}),e.jsx(s.Item,{name:"sinicize",label:"汉化组",children:e.jsx(l,{placeholder:"请输入汉化组"})}),e.jsx(s.Item,{name:"press",label:"出版社",children:e.jsx(l,{placeholder:"请输入出版社"})}),e.jsx(s.Item,{name:"page",label:"页码",validateFirst:!0,rules:[{required:!0},{validator:(a,t)=>!Number.isInteger(+t)&&+t>0?Promise.reject(new Error("页码必须是正整数!")):Promise.resolve()}],children:e.jsx(l,{type:"number",placeholder:"请输入页码"})}),e.jsx(s.Item,{name:"series",label:"系列",children:e.jsx(l,{placeholder:"请输入系列名称"})}),e.jsx(s.Item,{name:"seriesList",label:"系列列表",dependencies:["series"],rules:[{validator:(a,t)=>{if(b.getFieldValue("series")&&!t)return Promise.reject(new Error("系列列表不能为空!"));if(!t)return Promise.resolve();const n=t.split(" ").filter(r=>r).map(r=>r.split("-").map(d=>+d));if(!n.every(r=>r.every(d=>Number.isFinite(d)&&d>0)&&(r[1]?r[1]>r[0]:!0)))return Promise.reject(new Error("系列列表格式错误!"));const c=n.map(r=>r[1]?new Array(r[1]-r[0]+1).fill(r[0]).map((d,E)=>d+E):[r[0]]).flat();return c.length!==new Set(c).size?Promise.reject(new Error("系列列表有重复!")):Promise.resolve()}}],children:e.jsx(l,{placeholder:"请输入系列列表 数字 或者 数字-数字 或者 数字 数字"})}),e.jsx(s.Item,{name:"simpleDesc",label:"简短介绍",children:e.jsx(x,{placeholder:"请输入简短介绍",autoSize:!0})}),e.jsx(s.Item,{name:"desc",label:"描述",children:e.jsx(x,{placeholder:"请输入描述",autoSize:!0})}),e.jsx(s.Item,{name:"url",label:"地址",validateFirst:!0,rules:[{required:!0},{validator:(a,t)=>{try{new URL(t)}catch{return Promise.reject(new Error("url格式错误!"))}return!i&&F.includes(t)?Promise.reject(new Error("url不能重复!")):Promise.resolve()}}],children:e.jsx(x,{placeholder:"请输入地址",autoSize:!0})}),e.jsx(s.Item,{name:"icon",label:"icon",children:e.jsx(z,{multiple:!0,maxCount:1,upload:async a=>{const t=URL.createObjectURL(a),n=await U(t),m=await S(n),c=await v(m,n);return c.success?{url:c.data}:Promise.reject()}})}),e.jsx(s.Item,{name:"tags",label:"标签",children:e.jsx(k,{webConfig:o})}),e.jsx(y,{className:"ml-4 mb-2",size:"small",color:"primary",onClick:()=>{u(`${o.path}/tag`)},children:"新增"}),e.jsx(s.Item,{name:"order",label:"排序",rules:[{required:!0}],children:e.jsx(l,{type:"number",placeholder:"请输入排序"})})]})})};export{D as default};
