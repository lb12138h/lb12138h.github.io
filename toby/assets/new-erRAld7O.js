import{m as U,n as B,r as p,j as e,B as x,o as T,p as k,A as o,T as u}from"./index-DERllzhn.js";import{F as s,I as h}from"./input-Clf9kwip.js";import{I as R,d as S}from"./crypto-BQ1i6_9u.js";import{T as w}from"./text-area-iB4A7Wm-.js";import{u as g}from"./dexie-react-hooks-Dwhc-AuF.js";import{F as C}from"./FilterTag-OCnJNN3E.js";import"./index-hSoGQ23Z.js";import"./space-bauQVJ63.js";import"./selector-DpT9G-B8.js";const W=()=>{const l=U(),{id:n}=B(),d=g(()=>o.db.web.orderBy("order").last().then(r=>((r==null?void 0:r.order)||0)+1),[],0),y=g(async()=>await o.db.web.orderBy("url").keys(),[],[]),[b]=s.useForm(),[c,f]=p.useState(),[I,j]=p.useState(!1);p.useEffect(()=>{(async()=>{if(!n){d&&f({order:d});return}const t=await o.db.web.get(+n);if(!t){l(-1);return}f(t)})()},[d,n,l]);const L=async r=>{j(!0);const t=+r.order;if(t!==d&&t!==(c==null?void 0:c.order)){const m=(await o.db.web.orderBy("order").toArray()).filter(a=>n&&a.id!==+n).filter(a=>a.order&&a.order>=t).map((a,F)=>({key:a.id,changes:{order:F+t+1}}));m.length&&await o.db.web.bulkUpdate(m)}n?await o.db.web.update(+n,{...r,hostname:new URL(r.url).hostname,order:+r.order}).then(()=>{u.show({icon:"success",content:"编辑成功!"}),b.resetFields(),l(-1)}).catch(i=>{u.show({icon:"fail",content:i.message})}):await o.db.web.add({...r,hostname:new URL(r.url).hostname,order:+r.order}).then(()=>{u.show({icon:"success",content:"新建成功!"}),b.resetFields(),l(-1)}).catch(i=>{u.show({icon:"fail",content:i.message})}),j(!1)};return e.jsx("div",{children:c&&e.jsxs(s,{name:"form",form:b,onFinish:L,initialValues:c,footer:e.jsx(x,{block:!0,type:"submit",color:"primary",loading:I,children:"提交"}),children:[e.jsx(s.Item,{name:"title",label:"名称",rules:[{required:!0}],children:e.jsx(h,{placeholder:"请输入名称"})}),e.jsx(s.Item,{name:"url",label:"地址",validateFirst:!0,rules:[{required:!0},{validator:(r,t)=>{try{new URL(t)}catch{return Promise.reject(new Error("url格式错误!"))}return!n&&y.includes(t)?Promise.reject(new Error("url不能重复!")):Promise.resolve()}}],children:e.jsx(w,{placeholder:"请输入地址",autoSize:!0})}),e.jsx(s.Item,{name:"wh",label:"宽高",children:e.jsx(h,{placeholder:"请输入宽高"})}),e.jsx(s.Item,{name:"whr",label:"宽高比",children:e.jsx(h,{placeholder:"请输入宽高比"})}),e.jsx(s.Item,{name:"simpleDesc",label:"简短介绍",children:e.jsx(w,{placeholder:"请输入简短介绍",autoSize:!0})}),e.jsx(s.Item,{name:"desc",label:"描述",children:e.jsx(w,{placeholder:"请输入描述",autoSize:!0})}),e.jsx(s.Item,{name:"icon",label:"icon",children:e.jsx(R,{multiple:!0,maxCount:1,upload:async r=>{const t=URL.createObjectURL(r),i=await T(t),m=await S(i),a=await k(m,i);return a.success?{url:a.data}:Promise.reject()}})}),e.jsx(s.Item,{name:"tags",label:"标签",children:e.jsx(C,{webConfig:o})}),e.jsx(x,{className:"ml-4 mb-2",size:"small",color:"primary",onClick:()=>{l(`${o.path}/tag`)},children:"新增"}),e.jsx(s.Item,{name:"order",label:"排序",rules:[{required:!0}],children:e.jsx(h,{type:"number",placeholder:"请输入排序"})})]})})};export{W as default};
