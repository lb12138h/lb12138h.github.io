import{a as T,b as v,r as j,j as e,B as g,i as B,p as S,h as i,T as h}from"./index-DKKuqkso.js";import{F as t,I as l}from"./input-4uKEuujg.js";import{I as U,d as z}from"./crypto-COm7HR58.js";import{T as I}from"./text-area-lCAX-PYx.js";import{u as y}from"./dexie-react-hooks-pxC-h1Kn.js";import{F as C}from"./FilterTag-DYh5E1up.js";const _=()=>{const u=T(),{id:o}=v(),p=y(()=>i.db.web.orderBy("order").last().then(s=>((s==null?void 0:s.order)||0)+1),[],0),F=y(async()=>await i.db.web.orderBy("url").keys(),[],[]),[d]=t.useForm(),[b,x]=j.useState(),[P,f]=j.useState(!1);j.useEffect(()=>{(async()=>{if(!o){p&&x({order:p});return}const r=await i.db.web.get(+o);if(!r){u(-1);return}x(r)})()},[p,o,u]);const E=async s=>{f(!0);const r={...s,hostname:new URL(s.url).hostname,order:+s.order,page:+s.page};o?await i.db.web.update(+o,r).then(()=>{h.show({icon:"success",content:"编辑成功!"}),d.resetFields(),u(-1)}).catch(n=>{h.show({icon:"fail",content:n.message})}):await i.db.web.add(r).then(()=>{h.show({icon:"success",content:"新建成功!"}),d.resetFields(),u(-1)}).catch(n=>{h.show({icon:"fail",content:n.message})}),f(!1)};return e.jsx("div",{children:b&&e.jsxs(t,{name:"form",form:d,onFinish:E,initialValues:b,footer:e.jsx(g,{block:!0,type:"submit",color:"primary",loading:P,children:"提交"}),children:[e.jsx(t.Item,{name:"title",label:"名称",rules:[{required:!0}],children:e.jsx(l,{placeholder:"请输入名称"})}),e.jsx(t.Item,{name:"orginTitle",label:"源名称",children:e.jsx(l,{placeholder:"请输入源名称"})}),e.jsx(t.Item,{name:"inWebTitle",label:"网站中名称",children:e.jsx(l,{placeholder:"请输入网站中名称"})}),e.jsx(t.Item,{name:"author",label:"作者",children:e.jsx(l,{placeholder:"请输入作者"})}),e.jsx(t.Item,{name:"sinicize",label:"汉化组",children:e.jsx(l,{placeholder:"请输入汉化组"})}),e.jsx(t.Item,{name:"press",label:"出版社",children:e.jsx(l,{placeholder:"请输入出版社"})}),e.jsx(t.Item,{name:"page",label:"页码",validateFirst:!0,rules:[{required:!0},{validator:(s,r)=>!Number.isInteger(+r)&&+r>0?Promise.reject(new Error("页码必须是正整数!")):Promise.resolve()}],children:e.jsx(l,{type:"number",placeholder:"请输入页码"})}),e.jsx(t.Item,{name:"series",label:"系列",children:e.jsx(l,{placeholder:"请输入系列名称"})}),e.jsx(t.Item,{name:"seriesList",label:"系列列表",dependencies:["series"],rules:[{validator:(s,r)=>{if(d.getFieldValue("series")&&!r)return Promise.reject(new Error("系列列表不能为空!"));if(!r)return Promise.resolve();const n=r.split(" ").filter(a=>a).map(a=>a.split("-").map(c=>+c));if(!n.every(a=>a.every(c=>Number.isFinite(c)&&c>0)&&(a[1]?a[1]>a[0]:!0)))return Promise.reject(new Error("系列列表格式错误!"));const m=n.map(a=>a[1]?new Array(a[1]-a[0]+1).fill(a[0]).map((c,L)=>c+L):[a[0]]).flat();return m.length!==new Set(m).size?Promise.reject(new Error("系列列表有重复!")):Promise.resolve()}}],children:e.jsx(l,{placeholder:"请输入系列列表 数字 或者 数字-数字 或者 数字 数字"})}),e.jsx(t.Item,{name:"desc",label:"描述",children:e.jsx(I,{placeholder:"请输入描述",autoSize:!0})}),e.jsx(t.Item,{name:"url",label:"地址",validateFirst:!0,rules:[{required:!0},{validator:(s,r)=>{try{new URL(r)}catch{return Promise.reject(new Error("url格式错误!"))}return!o&&F.includes(r)?Promise.reject(new Error("url不能重复!")):Promise.resolve()}}],children:e.jsx(I,{placeholder:"请输入地址",autoSize:!0})}),e.jsx(t.Item,{name:"icon",label:"icon",children:e.jsx(U,{multiple:!0,maxCount:1,upload:async s=>{const r=URL.createObjectURL(s),n=await B(r),w=await z(n),m=await S(w,n);return m.success?{url:m.data}:Promise.reject()}})}),e.jsx(t.Item,{name:"tags",label:"标签",children:e.jsx(C,{webConfig:i})}),e.jsx(g,{className:"ml-4 mb-2",size:"small",color:"primary",onClick:()=>{u(`${i.path}/tag`)},children:"新增"}),e.jsx(t.Item,{name:"order",label:"排序",rules:[{required:!0}],children:e.jsx(l,{type:"number",placeholder:"请输入排序"})})]})})};export{_ as default};
